# Dockerメモ

<!-- TOC -->

- [Dockerメモ](#dockerメモ)
    - [概要](#概要)
    - [コンセプト](#コンセプト)
        - [マシンを超えたコンテナの移動](#マシンを超えたコンテナの移動)
        - [アプリケーション指向](#アプリケーション指向)
        - [自動ビルド](#自動ビルド)
        - [バージョン管理](#バージョン管理)
        - [コンポーネントの再利用](#コンポーネントの再利用)
        - [共有](#共有)
        - [ツールのエコシステム](#ツールのエコシステム)
    - [チュートリアル](#チュートリアル)
        - [Hello World表示](#hello-world表示)
        - [ubuntu起動](#ubuntu起動)
        - [Nginxの起動](#nginxの起動)
        - [コンテナの確認](#コンテナの確認)

<!-- /TOC -->

## 概要
- Linuxで動作するシンプルで使いやすい軽量コンテナ環境。
    - コンテナとは、仮想的なOS環境のこと。
    - コンテナを使うことで、一台のコンピュータに、複数の環境を作成することができる。
    - コンテナ以外の仮想環境として、下記のような仮想マシンがある。
        - VMware
        - Virtual Box
        - Xen
        - KVM
        - AWS
        - Azure
        - GCE
    - コンテナと仮想マシンの違いは、下記。
        - 独立性重視の`仮想マシン`
        - 軽量性重視の`コンテナ`
        - 一軒家(パソコン・サーバー)が`物理マシン`
        - 賃貸マンション(プライバシーの保全)が`仮想マシン`
        - シェアハウス(同じ家の中で分かれる)が`コンテナ`
- 物理マシン・仮想マシン・コンテナの構成は下記。

![test](https://user-images.githubusercontent.com/44114228/55439602-1bdcc800-55e0-11e9-9101-ac0d2a15c81f.png)

- 具体的な構成は下記。
    - 物理マシンは、１つのOSが動作して、その上で複数のプロセスが動作している。プロセスは隔離されていないため、CPU・メモリ・ディスク・ネットワークなどのリソースを共有している。
    - 仮想マシンは、物理的なハードウェアを分割して、複数の仮想的なコンピュータを作成する。各仮想マシンから見ると、CPU・メモリ・ディスク・ネットワークなどが、完全に独自のものとして、見える。各仮想マシンの上では、OSが動作して、さらにその上でアプリケーションが動作する。
    - コンテナでは、OSを論理的に分割して、仮想的にOS(Linux)を作成する。コンテナから見ると、ファイルシステムを始めとするOS上のリソースはコンテナ独自のものとして見える。あるコンテナのアプリケーションと、他のコンテナのアプリケーションは隔離されていて、そのままでは通信できない。しかし、OSはすべてのコンテナで同じものを利用しているため、必要に応じて他のコンテナとOS上のリソース（ファイルやネットワークインターフェース等）を共有できる。
- コンテナと仮想マシンの違いは下記。

||コンテナ|仮想マシン|
|:---:|:---:|:---:|
|**起動**|早い|遅い|
|**リソース消費**|少ない|多い|
|**OS**|Linuxのみ|何でも可|

## コンセプト
### マシンを超えたコンテナの移動
- Dockerは、アプリケーションや依存ファイルを1つのDockerイメージにまとめる。
- 同じイメージから作られる実行環境は同じになることが保証される。

### アプリケーション指向
- アプリケーションのデプロイに最適化される。
- ソフトウェアとしてのDockerだけでなく、API・ユーザーインターフェース・設計哲学・ドキュメンテーションに至るまで。

### 自動ビルド
- Dockerイメージの構築をコードとして記述することができる。
- そのため、コードから自動的にビルドするためのツールを提供する。

### バージョン管理
- gitのようなバージョン管理機能を提供する。
- Dockerイメージが作られるまでの履歴をたどることができ、イメージの差分更新もできる。

### コンポーネントの再利用
- どのコンテナでも、ベースイメージとして、再利用できる。
- Dockerイメージは、手動または設定ファイルからの自動ビルドで作成できる。
- また、もし理想のPython環境を1個用意できたら、それを元に異なるアプリケーション環境を複数用意できる。

### 共有
- Dockerイメージは、Docker Hub上で、世界中のユーザーと共有できる。

### ツールのエコシステム
- Dockerは、コンテナの作成やデプロイを自動化するためのAPIを定義している。
- また、多くのツールと連携している。

## チュートリアル
### Hello World表示
- ターミナルを起動
- 下記のコマンドをうつ。

```bash
$ docker run hello-world

~~~~~~~~
Hello from Docker.
```
- 「Hello from Docker」が表示されれば、完了。

### ubuntu起動
- ターミナルに下記のコマンドをうつ。

```console
$ docker run -i -t ubuntu /bin/bash
~~~~~~~~~~~~~~~~~~~~
root@XXXXX :/#
```

- 下記のコマンドをうち、ubuntu起動を確認。

```console
root@XXX :/# cat /etc/lsb-release

~~~~~~~~
DISTRIB_ID=Ubuntu
DISTRIB_RELEASE=XX.XX
```

- テストファイルの作成

```
root@XXX :/# echo hello > hello.txt
root@XXX :/# ll
~~~~~~
hello.txt

root@XXX :/# cat hello.txt
```

- 「Ctrl + D」でコンテナ終了

- 下記のコマンドで、再度コンテナ起動。

```console
$ docker run -i -t ubuntu /bin/bash
root@XXX :/# ll
~~~~~~~
```

- hello.txtがなくなっていればOK。

- 「Ctrl + D」でコンテナ終了。

### Nginxの起動
- 下記のコマンドをうち、Nginxイメージでの起動。

```console
$ docker run -p 8080:80 nginx
```

- ブラウザを起動して、「localhost:8080」にアクセス。

- ページ内に「Welcome to nginx」と表示されていれば、完了。

- 「Ctrl + C」でWebサーバーの終了をする。

### コンテナの確認

- 下記のコマンドをうち、動作しているコンテナの確認。

```console
$ docker ps
~~~~~~~~
CONTAINER id    IMAGE    COMMAND    CREATED
```

- 下記のコマンドをうち、動作しているコンテナの終了。

```console
$ docker kill コンテナID
```

- 下記のコマンドをうち、終了したコンテナも含めた一覧の確認。

```console
$ docker ps -a
~~~~~~~~
CONTAINER id    IMAGE    COMMAND    CREATED
```

- `docker run`で実行したコンテナが残っている状態になる。
- このままではディスクが消費するため、下記のコマンドをうち、コンテナを削除。

```console
$ docker rm コンテナID
```

- その他の下記コマンド。

|コマンド|内容|
|:---:|:---:|
|$docker kill<br>$docker ps -a|全てのコンテナを終了する。|
|$docker rm<br>$docker ps -a -q|すべての終了しているコンテナを削除する。|
|$docker rm -f<br>$docker ps -a -q|動作しているコンテナを含めて、すべてのコンテナを削除する。|