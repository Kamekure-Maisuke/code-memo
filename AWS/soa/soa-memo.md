# SOAメモ

<!-- TOC -->

- [SOAメモ](#soaメモ)
  - [概要](#概要)
  - [CloudWatch](#cloudwatch)
  - [CloudTrail](#cloudtrail)

<!-- /TOC -->

## 概要
- AWS認定試験の1つ、SysOpsアドミストレータアソシエイト(SOA)試験の学習メモ

## CloudWatch
- AWSのリソース使用状況の監視サービス。
- CPUやディスクIO、ネットワークラグなどの使用率についてリアルタイムでモニタリングしてくれる。
- 収集データは以下。
  - メトリクス
    - 数値化された使用状況
    - マネコンやCLIなどで確認可能。
    - **標準でCPUやディスクIOが取れる。**
    - OS内部データ(アプリケーションのメモリ使用量)などは別途**エージェント**をインストール。(**カスタムメトリクス**)
    - 「統計」「期間」「データポイント」によってアラームを設定することが可能。
    - アラームの状態は以下。
      - OK : 閾値より下
      - ALARM : 閾値より上
      - INSUFFICIENT_DATA : データ不足。判定不能状態。
      - **詳細モニタリング**を有効にしておく必要がある。
  - ログ
    - システムによって送信されるログの管理・検索などができる
    - LambdaやAPI Gatewayは標準でついている。EC2は別途エージェントをインストール
    - **メトリクスフィルター**機能でログをフィルタリングしてメトリクスを増やすことができる。
      - 例 : 「404」文字列が入っていたら、メトリクスを増やしてCloudWatchアラームに設定。
  - イベント
    - リソースの変更によって作業を行いたい時に利用。
    - 方式は以下2つ
      - **時間ベース** : 定時実行。cron・rate
        - 毎朝10時にAWS Batchジョブの実行
      - **システムイベント** : リソースのイベントによって実行。
        - 例 : インスタンス起動時にlambda実行

## CloudTrail
- AWSのアカウント作業ログを記録できるサービス
- 以下例。
  - 深夜に利用したユーザーの特定
  - セキュリティグループ変更したユーザーの特定
  - 不正アクセスの有無
- 連携できるサービスは以下。
  - s3
    - 証跡の管理・バックアップ
  - cloudwatch logs
    - メトリクスフィルターによりイベントの監視
  - cloudwatch event(event bridge)
    - 証跡イベントのルールを設定して、他サービスの自動実行

## AWS Config
- リソースの設定を評価・監査・審査できるサービス。
- 設定変更の記録に特化している。
  - cloudtrailは全て記録する。
- 設定変更の際にSNS通知のトリガーなどができる。
- 連携できるサービスは以下。
  - aws config api
  - s3
  - cloudwatch
  - sns
- 評価のためにはルールの作成が必要。種類は以下。
  - **マネージドルール** : 事前定義済みのルール
  - **カスタムルール** : 独自評価を行うルール
    - ルールはlambda作成
- 評価のタイミングは以下。
  - 設定変更 : リソース変更の際。
  - 定期的 : 指定した間隔ごと。
- 有効化しておくべきマネージドルールは以下。
  - cloudtrail-enabled : cloudtrailが有効になっているか
    - 定期的
  - ec2-evs-encryptioon-by-default : ebs暗号化が有効になっているか
    - 定期的
  - ec2-instance-no-public-ip : パブリックIPが関連づけられているか
    - 設定変更
  - iam-user-mfa-enabled : IAMのMFA認証が有効になっているか。
    - 定期的
  - s3-account-level-public-access : s3のパブリックアクセスブロックがアカウントレベル設定されているか
- 定義したルールに合わない場合、**修復アクション**を実行
  - **system manager automation**
  - 例 : cloudtrailの証跡有効化・s3バケットの非公開・インスタンスの停止
  - 使えるタスクはAWS公開のやつも自分で作成したものでも可。